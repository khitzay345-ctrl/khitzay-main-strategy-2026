{% extends "base.html" %}
{% block content %}

<style>
:root {
  --dna-bg: #050914;
  --dna-card: rgba(13, 21, 37, 0.72);
  --dna-border: rgba(148, 163, 184, 0.3);
  --dna-glow: rgba(59, 130, 246, 0.6);
}

.ecom-wrapper { max-width: 1200px; margin: 20px auto 28px; }
.hero-card {
  background: radial-gradient(circle at top left,#3b82f6,#1d4ed8 70%);
  color:#fff;
  padding:22px 22px 18px;
  border-radius:22px;
  box-shadow:0 24px 55px rgba(2,6,23,0.4);
  margin-bottom:18px;
}
.hero-card h1 { margin:0; font-weight:800; letter-spacing:-0.05em; }
.hero-card p { margin-top:6px;opacity:.88; }
.hero-chips{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.75rem;}
.hero-chip{padding:0.2rem 0.6rem;border-radius:999px;border:1px solid rgba(191,219,254,0.7);font-size:.72rem;color:#e5e7eb;background:rgba(15,23,42,0.18);}  
.nav-tabs { border:none; margin-bottom:18px; }
.nav-tabs .nav-link { border:none; border-radius:999px; padding:10px 20px; font-weight:600; color:#4d5b6c; }
.nav-tabs .nav-link.active { background:#3b82f6; color:#fff; box-shadow:0 10px 20px rgba(59,130,246,.25); }
.table-card { background:var(--dna-card); border-radius:22px; padding:22px; box-shadow:0 25px 45px rgba(2,6,23,.4); border:1px solid var(--dna-border); }
.e-table { width:100%; border-collapse:separate; border-spacing:0; }
.e-table thead th { text-align:left; text-transform:uppercase; font-size:.75rem; letter-spacing:1px; padding:14px 12px; color:#94a3b8; border-bottom:2px solid var(--dna-border); background:rgba(15,23,42,0.5); }
.e-table tbody td { padding:14px 12px; border-bottom:1px solid var(--dna-border); color:#e2e8f0; }
.e-table tbody tr:last-child td { border-bottom:none; }
.e-table tbody tr:hover { background:linear-gradient(90deg,rgba(59,130,246,0.1),rgba(29,78,216,0.05)); }
.stat-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(210px,1fr)); gap:18px; margin-bottom:20px; }
.stat-card {
  background:linear-gradient(135deg,var(--dna-card),rgba(15,23,42,0.8));
  border-radius:18px;
  padding:16px 16px 14px;
  box-shadow:0 18px 38px rgba(2,6,23,.4);
  display:flex;
  flex-direction:column;
  gap:2px;
  border:1px solid var(--dna-border);
}
.stat-card span { text-transform:uppercase; font-size:.72rem; letter-spacing:.5px; color:#94a3b8; }
.stat-card strong { font-size:1.6rem; color:#f1f5f9; }
.stat-card small { font-size:.8rem; color:#64748b; }
.delta-pill { padding:4px 10px; border-radius:999px; font-size:.75rem; background:rgba(15,185,129,.15); color:#0f8266; }
.bad { background:rgba(229,72,72,.1); color:#c73737; }

/* 2026 Realistic 2x Tab Styles */
.realistic-stats-grid { 
  display:grid; 
  grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); 
  gap:20px; 
  margin-bottom:24px; 
}
.realistic-stat-card {
  background:linear-gradient(135deg,var(--dna-card),rgba(15,23,42,0.8));
  border-radius:20px;
  padding:20px;
  box-shadow:0 20px 40px rgba(2,6,23,.4);
  color:#fff;
  position:relative;
  overflow:hidden;
  transform:translateY(0);
  transition:all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation:slideInUp 0.6s ease-out forwards;
  opacity:0;
  border:1px solid var(--dna-border);
}
.realistic-stat-card:nth-child(1) { animation-delay:0.1s; }
.realistic-stat-card:nth-child(2) { animation-delay:0.2s; }
.realistic-stat-card:nth-child(3) { animation-delay:0.3s; }
.realistic-stat-card:nth-child(4) { animation-delay:0.4s; }
.realistic-stat-card:nth-child(5) { animation-delay:0.5s; }
.realistic-stat-card:nth-child(6) { animation-delay:0.6s; }

.realistic-stat-card:hover {
  transform:translateY(-8px) scale(1.02);
  box-shadow:0 25px 50px rgba(2,6,23,.5);
}
.realistic-stat-card::before {
  content:'';
  position:absolute;
  top:-50%;
  right:-50%;
  width:200%;
  height:200%;
  background:radial-gradient(circle,rgba(59,130,246,0.1) 0%,transparent 70%);
  animation:rotate 20s linear infinite;
}
.realistic-stat-card .stat-icon {
  font-size:2.5rem;
  margin-bottom:12px;
  opacity:0.9;
}
.realistic-stat-card .stat-label {
  font-size:0.85rem;
  text-transform:uppercase;
  letter-spacing:1px;
  opacity:0.9;
  margin-bottom:8px;
}
.realistic-stat-card .stat-value {
  font-size:2.2rem;
  font-weight:800;
  margin-bottom:4px;
}
.realistic-stat-card .stat-subtitle {
  font-size:0.9rem;
  opacity:0.8;
}

.realistic-table-card {
  background:var(--dna-card);
  border-radius:24px;
  padding:28px;
  box-shadow:0 30px 60px rgba(2,6,23,.4);
  animation:fadeInScale 0.8s ease-out 0.7s both;
  border:1px solid var(--dna-border);
}
.realistic-table {
  width:100%;
  border-collapse:separate;
  border-spacing:0;
}
.realistic-table thead th {
  text-align:left;
  text-transform:uppercase;
  font-size:0.8rem;
  letter-spacing:1.5px;
  padding:16px 14px;
  color:#94a3b8;
  border-bottom:3px solid var(--dna-border);
  background:rgba(15,23,42,0.5);
  font-weight:700;
  position:sticky;
  top:0;
  z-index:10;
}
.realistic-table tbody td {
  padding:16px 14px;
  border-bottom:1px solid var(--dna-border);
  transition:all 0.2s ease;
  color:#e2e8f0;
}
.realistic-table tbody tr {
  transition:all 0.3s ease;
  animation:slideInLeft 0.5s ease-out forwards;
  opacity:0;
}
.realistic-table tbody tr:nth-child(1) { animation-delay:0.8s; }
.realistic-table tbody tr:nth-child(2) { animation-delay:0.9s; }
.realistic-table tbody tr:nth-child(3) { animation-delay:1.0s; }
.realistic-table tbody tr:nth-child(4) { animation-delay:1.1s; }
.realistic-table tbody tr:nth-child(5) { animation-delay:1.2s; }
.realistic-table tbody tr:nth-child(6) { animation-delay:1.3s; }
.realistic-table tbody tr:nth-child(7) { animation-delay:1.4s; }
.realistic-table tbody tr:nth-child(8) { animation-delay:1.5s; }
.realistic-table tbody tr:nth-child(9) { animation-delay:1.6s; }
.realistic-table tbody tr:nth-child(10) { animation-delay:1.7s; }
.realistic-table tbody tr:nth-child(11) { animation-delay:1.8s; }
.realistic-table tbody tr:nth-child(12) { animation-delay:1.9s; }
.realistic-table tbody tr:nth-child(13) { animation-delay:2.0s; }
.realistic-table tbody tr:nth-child(14) { animation-delay:2.1s; }
.realistic-table tbody tr:nth-child(15) { animation-delay:2.2s; }
.realistic-table tbody tr:nth-child(16) { animation-delay:2.3s; }
.realistic-table tbody tr:nth-child(17) { animation-delay:2.4s; }

.realistic-table tbody tr:hover {
  background:linear-gradient(90deg,rgba(59,130,246,0.1),rgba(29,78,216,0.05));
  transform:scale(1.01);
  box-shadow:0 4px 20px rgba(59,130,246,.2);
}
.realistic-table tbody tr:last-child td { border-bottom:none; }
.brand-cell {
  font-weight:600;
  color:#f1f5f9;
  position:relative;
}
.brand-cell::before {
  content:'';
  position:absolute;
  left:-8px;
  top:50%;
  transform:translateY(-50%);
  width:4px;
  height:0;
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
  border-radius:2px;
  transition:height 0.3s ease;
}
.realistic-table tbody tr:hover .brand-cell::before {
  height:70%;
}
.sales-cell {
  text-align:right;
  font-weight:500;
  color:#e2e8f0;
  font-family:'Courier New', monospace;
}
.sales-cell.highlight {
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
  color:#fff;
  border-radius:8px;
  font-weight:700;
}

@keyframes slideInUp {
  from {
    opacity:0;
    transform:translateY(30px);
  }
  to {
    opacity:1;
    transform:translateY(0);
  }
}
@keyframes slideInLeft {
  from {
    opacity:0;
    transform:translateX(-20px);
  }
  to {
    opacity:1;
    transform:translateX(0);
  }
}
@keyframes fadeInScale {
  from {
    opacity:0;
    transform:scale(0.95);
  }
  to {
    opacity:1;
    transform:scale(1);
  }
}
@keyframes rotate {
  from { transform:rotate(0deg); }
  to { transform:rotate(360deg); }
}

/* Filter Controls Styles */
.filter-section {
  background:linear-gradient(135deg,var(--dna-card),rgba(15,23,42,0.8));
  border-radius:20px;
  padding:24px;
  margin-bottom:24px;
  box-shadow:0 10px 25px rgba(2,6,23,.4);
  animation:slideInUp 0.6s ease-out 0.3s both;
  border:1px solid var(--dna-border);
}
.filter-controls {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
  gap:20px;
  margin-bottom:20px;
}
.filter-group {
  display:flex;
  flex-direction:column;
  gap:8px;
}
.filter-group label {
  font-size:0.85rem;
  font-weight:600;
  color:#94a3b8;
  text-transform:uppercase;
  letter-spacing:0.5px;
}
.filter-select {
  padding:12px 16px;
  border:2px solid var(--dna-border);
  border-radius:12px;
  background:var(--dna-card);
  font-size:0.95rem;
  transition:all 0.3s ease;
  cursor:pointer;
  color:#e2e8f0;
}
.filter-select:hover {
  border-color:#3b82f6;
  box-shadow:0 4px 12px rgba(59,130,246,.3);
}
.filter-select:focus {
  outline:none;
  border-color:#3b82f6;
  box-shadow:0 0 0 3px rgba(59,130,246,.2);
}
.filter-actions {
  display:flex;
  gap:12px;
  flex-wrap:wrap;
}
.filter-btn {
  padding:10px 20px;
  border:none;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
  transition:all 0.3s ease;
  font-size:0.9rem;
}
.filter-btn-primary {
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
  color:#fff;
  box-shadow:0 4px 15px rgba(59,130,246,.4);
}
.filter-btn-primary:hover {
  transform:translateY(-2px);
  box-shadow:0 6px 20px rgba(59,130,246,.5);
}
.filter-btn-secondary {
  background:var(--dna-card);
  color:#94a3b8;
  border:2px solid var(--dna-border);
}
.filter-btn-secondary:hover {
  background:rgba(15,23,42,0.9);
  border-color:#3b82f6;
}

/* Chart Container */
.chart-section {
  background:var(--dna-card);
  border-radius:24px;
  padding:28px;
  box-shadow:0 30px 60px rgba(2,6,23,.4);
  margin-bottom:24px;
  animation:fadeInScale 0.8s ease-out 1.0s both;
  border:1px solid var(--dna-border);
}
.chart-header {
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:24px;
}
.chart-title {
  font-size:1.4rem;
  font-weight:700;
  color:#f1f5f9;
}
.chart-container {
  position:relative;
  height:400px;
  width:100%;
}

/* Annual Totals Section */
.annual-totals-section {
  background:linear-gradient(135deg,var(--dna-card),rgba(15,23,42,0.8));
  border-radius:20px;
  padding:24px;
  margin-bottom:24px;
  box-shadow:0 20px 40px rgba(2,6,23,.4);
  animation:slideInUp 0.6s ease-out 0.5s both;
  border:1px solid var(--dna-border);
}
.totals-list {
  display:grid;
  grid-template-columns: repeat(auto-fit,minmax(250px,1fr));
  gap:16px;
}
.total-item {
  background:var(--dna-card);
  border-radius:12px;
  padding:16px 20px;
  border:1px solid var(--dna-border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  transition:all 0.3s ease;
  position:relative;
  overflow:hidden;
}
.total-item::before {
  content:'';
  position:absolute;
  top:0;
  left:0;
  width:3px;
  height:100%;
  background:linear-gradient(135deg,#3b82f6,#1d4ed8);
}
.total-item:hover {
  transform:translateY(-2px);
  box-shadow:0 8px 25px rgba(2,6,23,.5);
  border-color:#3b82f6;
}
.brand-name {
  font-size:1rem;
  font-weight:600;
  color:#f1f5f9;
}
.total-amount {
  font-size:1.2rem;
  font-weight:700;
  color:#3b82f6;
  font-family:'Courier New', monospace;
}
</style>

<div class="ecom-wrapper">
  <div class="hero-card">
    <h1>E-commerce Performance</h1>
    <p>Targets for 2026 plus a comparison snapshot of 2024 vs 2025 actuals.</p>
    <div class="hero-chips">
      <span class="hero-chip">Traffic & Conversion</span>
      <span class="hero-chip">Average Basket</span>
      <span class="hero-chip">Year-on-Year Growth</span>
    </div>
  </div>

  <ul class="nav nav-tabs">
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'target' %}active{% endif %}" href="/ecom">2026 Target Plan</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'comparison' %}active{% endif %}" href="/ecom_comp">2024 vs 2025 Comparison</a>
    </li>
    <li class="nav-item">
      <a class="nav-link {% if active_tab == 'realistic_2x' %}active{% endif %}" href="/ecom_realistic_2x">2026 Realistic 2x</a>
    </li>
  </ul>

  {% if active_tab == 'target' %}
  <div class="table-card">
    {% if target_columns and target_rows %}
    <div class="table-responsive">
      <table class="e-table">
        <thead>
          <tr>
            {% for c in target_columns %}<th>{{ c }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in target_rows %}
          {% set first = r[target_columns[0]]|lower %}
          <tr class="{% if 'grand' in first or 'total' in first %}fw-bold{% endif %}">
            {% for c in target_columns %}
              {% set val = r[c] %}
              <td class="{% if val is string and val.replace(',','').replace('.','').isdigit() %}text-end{% endif %}">{{ val }}</td>
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div>No data found for sheet <strong>2026 Ecom Target</strong>.</div>
    {% endif %}
  </div>
  {% if target_insight %}
  <div class="alert alert-info mt-3" style="border-radius:14px;">
    <strong>Insight</strong>
    <div style="white-space:pre-wrap; margin-top:6px;">{{ target_insight }}</div>
  </div>
  {% endif %}
  {% endif %}

  {% if active_tab == 'comparison' %}
  <div class="stat-grid">
    <div class="stat-card">
      <span>Total 2024</span>
      <strong>{{ comp_summary.total_2024 }}</strong>
      <small>Baseline year</small>
    </div>
    <div class="stat-card">
      <span>Total 2025</span>
      <strong>{{ comp_summary.total_2025 }}</strong>
      <small>Growth vs 2024</small>
    </div>
    <div class="stat-card">
      <span>Avg 2024</span>
      <strong>{{ comp_summary.avg_2024 }}</strong>
      <small>Monthly average</small>
    </div>
    <div class="stat-card">
      <span>Avg 2025</span>
      <strong>{{ comp_summary.avg_2025 }}</strong>
      <small>Monthly average</small>
    </div>
    <div class="stat-card">
      <span>Max Month</span>
      <strong>{{ comp_summary.max_month }}</strong>
      <small>{{ comp_summary.max_value }}</small>
    </div>
    <div class="stat-card">
      <span>Min Month*</span>
      <strong>{{ comp_summary.min_month }}</strong>
      <small>{{ comp_summary.min_value }}</small>
    </div>
  </div>

  <div class="table-card">
    {% if comp_rows %}
    <div class="table-responsive">
      <table class="e-table">
        <thead>
          <tr>
            <th>Months</th>
            <th class="text-end">2024</th>
            <th class="text-end">2025</th>
            <th class="text-end">Œî % (2025 vs 2024)</th>
          </tr>
        </thead>
        <tbody>
          {% for row in comp_rows %}
          {% set pct = row['delta_pct'] if row['delta_pct'] is not none else 0 %}
          {% set positive = pct >= 0 %}
          <tr>
            <td>{{ row['Months'] }}</td>
            <td class="text-end">{{ row['2024_fmt'] }}</td>
            <td class="text-end">{{ row['2025_fmt'] }}</td>
            <td class="text-end">
              <span class="delta-pill {% if not positive %}bad{% endif %}">
                {% if positive and row['delta_pct_fmt'] != '‚Äî' %}+{% endif %}{{ row['delta_pct_fmt'] }}
              </span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div>No comparison data found for sheet <strong>ecom 2024 vs 2025</strong>.</div>
    {% endif %}
  
  </div>
  {% endif %}

  {% if active_tab == 'realistic_2x' %}
  <!-- Filter Controls -->
  <div class="filter-section">
    <div class="filter-controls">
      <div class="filter-group">
        <label for="brandFilter">Filter by Brand</label>
        <select id="brandFilter" class="filter-select">
          <option value="">All Brands</option>
          {% for brand in realistic_2x_brands %}
          <option value="{{ brand }}">{{ brand }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="monthFilter">Filter by Month</label>
        <select id="monthFilter" class="filter-select">
          <option value="">All Months</option>
          {% for month in realistic_2x_months %}
          <option value="{{ month }}">{{ month }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="filter-group">
        <label for="chartType">Chart Type</label>
        <select id="chartType" class="filter-select">
          <option value="line">Line Chart</option>
          <option value="bar">Bar Chart</option>
          <option value="area">Area Chart</option>
        </select>
      </div>
    </div>
    <div class="filter-actions">
      <button class="filter-btn filter-btn-primary" onclick="applyFilters()">Apply Filters</button>
      <button class="filter-btn filter-btn-secondary" onclick="resetFilters()">Reset</button>
    </div>
  </div>

  <!-- Interactive Chart -->
  <div class="chart-section">
    <div class="chart-header">
      <h2 class="chart-title">Brand Performance Over Time</h2>
      <div class="filter-actions">
        <button class="filter-btn filter-btn-primary" onclick="exportChart()">Export Chart</button>
      </div>
    </div>
    <div class="chart-container">
      <canvas id="performanceChart"></canvas>
    </div>
  </div>

  <!-- Sales Target Table -->
  <div class="realistic-table-card">
    {% if realistic_2x_columns and realistic_2x_rows %}
    <div class="table-responsive">
      <table class="realistic-table">
        <thead>
          <tr>
            {% for c in realistic_2x_columns %}<th>{{ c }}</th>{% endfor %}
          </tr>
        </thead>
        <tbody>
          {% for r in realistic_2x_rows %}
          {% set first = r[realistic_2x_columns[0]]|lower %}
          <tr class="{% if 'grand' in first or 'total' in first %}fw-bold{% endif %}">
            {% for c in realistic_2x_columns %}
              {% set val = r[c] %}
              {% if loop.first %}
                <td class="brand-cell">{{ val }}</td>
              {% elif val is string and val.replace(',','').replace('.','').isdigit() %}
                <td class="sales-cell {% if 'total' in first or 'grand' in first %}highlight{% endif %}">{{ val }}</td>
              {% else %}
                <td class="sales-cell">{{ val }}</td>
              {% endif %}
            {% endfor %}
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <div>No data found for sheet <strong>2026_Realistic_2x</strong>.</div>
    {% endif %}
  </div>

  <!-- Annual Totals List -->
  <div class="annual-totals-section">
    <h2 style="font-size:1.3rem; font-weight:700; color:#f1f5f9; margin-bottom:20px;">Annual Totals by Brand</h2>
    <div class="totals-list">
      {% for goal in realistic_2x_annual_goals %}
      <div class="total-item">
        <div class="brand-name">{{ goal.brand }}</div>
        <div class="total-amount">{{ goal.target_formatted }}</div>
      </div>
      {% endfor %}
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="realistic-stats-grid">
    <div class="realistic-stat-card">
      <div class="stat-icon">üìä</div>
      <div class="stat-label">Total Sales Target</div>
      <div class="stat-value">{{ realistic_2x_summary.total_sales|default('0') }}</div>
      <div class="stat-subtitle">Annual Goal 2026</div>
    </div>
    <div class="realistic-stat-card">
      <div class="stat-icon">üìà</div>
      <div class="stat-label">Monthly Average</div>
      <div class="stat-value">{{ realistic_2x_summary.monthly_avg|default('0') }}</div>
      <div class="stat-subtitle">Per Month Target</div>
    </div>
    <div class="realistic-stat-card">
      <div class="stat-icon">üéØ</div>
      <div class="stat-label">Best Month</div>
      <div class="stat-value">{{ realistic_2x_summary.best_month|default('N/A') }}</div>
      <div class="stat-subtitle">{{ realistic_2x_summary.best_value|default('0') }}</div>
    </div>
    <div class="realistic-stat-card">
      <div class="stat-icon">üìâ</div>
      <div class="stat-label">Lowest Month</div>
      <div class="stat-value">{{ realistic_2x_summary.lowest_month|default('N/A') }}</div>
      <div class="stat-subtitle">{{ realistic_2x_summary.lowest_value|default('0') }}</div>
    </div>
    <div class="realistic-stat-card">
      <div class="stat-icon">üèÜ</div>
      <div class="stat-label">Top Brand</div>
      <div class="stat-value">{{ realistic_2x_summary.top_brand|default('N/A') }}</div>
      <div class="stat-subtitle">{{ realistic_2x_summary.top_brand_value|default('0') }}</div>
    </div>
    <div class="realistic-stat-card">
      <div class="stat-icon">üîÑ</div>
      <div class="stat-label">Growth Factor</div>
      <div class="stat-value">2.0x</div>
      <div class="stat-subtitle">Realistic Target</div>
    </div>
  </div>

  {% if realistic_2x_insight %}
  <div class="alert alert-info mt-3" style="border-radius:14px; background:linear-gradient(135deg,rgba(59,130,246,0.15),rgba(29,78,216,0.15)); border:1px solid rgba(59,130,246,0.3);">
    <strong style="color:#3b82f6;">üí° Strategic Insight</strong>
    <div style="white-space:pre-wrap; margin-top:8px; color:#e2e8f0;">{{ realistic_2x_insight }}</div>
  </div>
  {% endif %}
  {% endif %}
</div>

<!-- Hidden data elements for JavaScript -->
<div id="chart-data" style="display: none;">{{ realistic_2x_chart_data|tojson|safe }}</div>
<div id="annual-goals-data" style="display: none;">{{ realistic_2x_annual_goals|tojson|safe }}</div>

<!-- Chart.js Library -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// Enhanced color palette for better visibility
const colorPalette = [
    'rgba(59, 130, 246, 1)',     // Blue
    'rgba(239, 68, 68, 1)',        // Red
    'rgba(34, 197, 94, 1)',        // Green
    'rgba(251, 146, 60, 1)',       // Orange
    'rgba(168, 85, 247, 1)',       // Purple
    'rgba(14, 165, 233, 1)',       // Sky Blue
    'rgba(236, 72, 153, 1)',       // Pink
    'rgba(20, 184, 166, 1)',       // Teal
    'rgba(245, 158, 11, 1)',       // Amber
    'rgba(99, 102, 241, 1)',       // Indigo
    'rgba(236, 72, 153, 1)',       // Pink (duplicate for more brands)
    'rgba(34, 197, 94, 1)',       // Green (duplicate)
    'rgba(251, 146, 60, 1)',      // Orange (duplicate)
    'rgba(168, 85, 247, 1)',       // Purple (duplicate)
    'rgba(14, 165, 233, 1)',       // Sky Blue (duplicate)
    'rgba(20, 184, 166, 1)'        // Teal (duplicate)
];

// Data from backend - safely parse JSON
let chartData = { labels: [], datasets: [] };
let annualGoals = [];

// Initialize data when page loads
function initializeData() {
    try {
        const chartDataElement = document.getElementById('chart-data');
        if (chartDataElement) {
            chartData = JSON.parse(chartDataElement.textContent);
        }
    } catch(e) {
        console.error('Error parsing chart data:', e);
    }
    
    try {
        const annualGoalsElement = document.getElementById('annual-goals-data');
        if (annualGoalsElement) {
            annualGoals = JSON.parse(annualGoalsElement.textContent);
        }
    } catch(e) {
        console.error('Error parsing annual goals:', e);
    }
}

let currentChart = null;

// Initialize chart on page load
document.addEventListener('DOMContentLoaded', function() {
    initializeData();
    initializeChart();
});

function initializeChart() {
    const ctx = document.getElementById('performanceChart').getContext('2d');
    const chartType = document.getElementById('chartType').value;
    
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Find top brand for each month
    const topBrandData = {};
    chartData.labels.forEach((month, monthIndex) => {
        let maxValue = 0;
        let topBrand = '';
        
        chartData.datasets.forEach(dataset => {
            const value = dataset.data[monthIndex];
            if (value > maxValue) {
                maxValue = value;
                topBrand = dataset.label;
            }
        });
        
        topBrandData[monthIndex] = { brand: topBrand, value: maxValue };
    });
    
    // Create custom plugin for top brand labels
    const topBrandPlugin = {
        id: 'topBrandLabels',
        afterDatasetsDraw(chart, args, options) {
            const { ctx, data, chartArea: { top, bottom, left, right, width, height }, scales: { x, y } } = chart;
            
            data.labels.forEach((label, index) => {
                const topInfo = topBrandData[index];
                if (topInfo && topInfo.value > 0) {
                    const xPos = x.getPixelForValue(index);
                    const yPos = y.getPixelForValue(topInfo.value);
                    
                    // Draw label background
                    ctx.save();
                    ctx.fillStyle = 'rgba(59, 130, 246, 0.9)';
                    ctx.strokeStyle = '#ffffff';
                    ctx.lineWidth = 2;
                    ctx.font = 'bold 11px Arial';
                    
                    const labelText = topInfo.brand;
                    const textWidth = ctx.measureText(labelText).width;
                    const padding = 6;
                    const boxHeight = 20;
                    
                    // Draw rounded rectangle background
                    const boxX = xPos - textWidth/2 - padding;
                    const boxY = yPos - boxHeight - 8;
                    
                    ctx.beginPath();
                    ctx.roundRect(boxX, boxY, textWidth + padding*2, boxHeight, 4);
                    ctx.fill();
                    ctx.stroke();
                    
                    // Draw text
                    ctx.fillStyle = '#ffffff';
                    ctx.fillText(labelText, xPos - textWidth/2, boxY + 14);
                    
                    // Draw small arrow pointing to the point
                    ctx.beginPath();
                    ctx.moveTo(xPos, boxY + boxHeight);
                    ctx.lineTo(xPos - 3, boxY + boxHeight + 4);
                    ctx.lineTo(xPos + 3, boxY + boxHeight + 4);
                    ctx.closePath();
                    ctx.fill();
                    
                    ctx.restore();
                }
            });
        }
    };
    
    const filteredData = getFilteredData();
    
    currentChart = new Chart(ctx, {
        type: chartType === 'area' ? 'line' : chartType,
        data: {
            labels: filteredData.labels,
            datasets: filteredData.datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: {
                    position: 'top',
                    labels: {
                        usePointStyle: true,
                        padding: 15,
                        font: {
                            size: 12,
                            weight: '600',
                            color: '#ffffff'
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(255, 255, 255, 0.95)',
                    titleColor: '#1e293b',
                    bodyColor: '#64748b',
                    borderColor: '#e2e8f0',
                    borderWidth: 1,
                    padding: 12,
                    displayColors: true,
                    callbacks: {
                        label: function(context) {
                            let label = context.dataset.label || '';
                            if (label) {
                                label += ': ';
                            }
                            if (context.parsed.y !== null) {
                                label += new Intl.NumberFormat('en-US', { 
                                    style: 'currency', 
                                    currency: 'USD',
                                    minimumFractionDigits: 0,
                                    maximumFractionDigits: 0
                                }).format(context.parsed.y);
                            }
                            return label;
                        }
                    }
                },
                topBrandLabels: topBrandPlugin
            },
            scales: {
                x: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Months',
                        color: '#ffffff',
                        font: {
                            size: 14,
                            weight: '600'
                        }
                    },
                    ticks: {
                        color: '#ffffff',
                        font: {
                            size: 12,
                            weight: '500'
                        }
                    },
                    grid: {
                        display: false
                    }
                },
                y: {
                    display: true,
                    title: {
                        display: true,
                        text: 'Sales Target',
                        color: '#ffffff',
                        font: {
                            size: 14,
                            weight: '600'
                        }
                    },
                    ticks: {
                        color: '#ffffff',
                        font: {
                            size: 12,
                            weight: '500'
                        },
                        callback: function(value) {
                            return new Intl.NumberFormat('en-US', { 
                                style: 'currency', 
                                currency: 'USD',
                                minimumFractionDigits: 0,
                                maximumFractionDigits: 0
                            }).format(value);
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.1)'
                    }
                }
            },
            elements: {
                line: {
                    tension: 0.4,
                    borderWidth: 3
                },
                point: {
                    radius: 5,
                    hoverRadius: 8,
                    borderWidth: 2,
                    borderColor: '#ffffff'
                }
            },
            animation: {
                duration: 1500,
                easing: 'easeInOutQuart'
            }
        }
    });
    
    if (chartType === 'area') {
        currentChart.data.datasets.forEach(dataset => {
            dataset.fill = true;
            dataset.backgroundColor = dataset.borderColor.replace('rgb', 'rgba').replace(')', ', 0.1)');
        });
    }
}

function getFilteredData() {
    const brandFilter = document.getElementById('brandFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;
    
    let filteredDatasets = chartData.datasets.map((dataset, index) => {
        if (brandFilter && dataset.label !== brandFilter) {
            return null;
        }
        
        let filteredData = [...dataset.data];
        if (monthFilter) {
            const monthIndex = chartData.labels.indexOf(monthFilter);
            if (monthIndex !== -1) {
                filteredData = dataset.data.map((value, index) => 
                    index === monthIndex ? value : null
                );
            }
        }
        
        return {
            ...dataset,
            data: filteredData,
            borderColor: colorPalette[index % colorPalette.length],
            backgroundColor: chartType === 'area' ? 
                colorPalette[index % colorPalette.length].replace('1)', '0.2)') : 
                colorPalette[index % colorPalette.length].replace('1)', '0.8)'),
            pointBackgroundColor: colorPalette[index % colorPalette.length],
            pointBorderColor: '#ffffff',
            pointHoverBackgroundColor: '#ffffff',
            pointHoverBorderColor: colorPalette[index % colorPalette.length],
            borderWidth: 3,
            pointRadius: 5,
            pointHoverRadius: 8
        };
    }).filter(dataset => dataset !== null);
    
    let filteredLabels = [...chartData.labels];
    if (monthFilter && filteredDatasets.length > 0) {
        filteredLabels = chartData.labels.map(label => 
            label === monthFilter ? label : ''
        );
    }
    
    return {
        labels: filteredLabels,
        datasets: filteredDatasets
    };
}

function applyFilters() {
    initializeChart();
    updateTable();
}

function resetFilters() {
    document.getElementById('brandFilter').value = '';
    document.getElementById('monthFilter').value = '';
    document.getElementById('chartType').value = 'line';
    initializeChart();
    updateTable();
}

function updateTable() {
    const brandFilter = document.getElementById('brandFilter').value;
    const monthFilter = document.getElementById('monthFilter').value;
    const rows = document.querySelectorAll('.realistic-table tbody tr');
    
    rows.forEach(row => {
        const brandCell = row.querySelector('.brand-cell');
        const brand = brandCell ? brandCell.textContent.trim() : '';
        const monthCells = row.querySelectorAll('.sales-cell');
        
        let showRow = true;
        
        if (brandFilter && brand !== brandFilter) {
            showRow = false;
        }
        
        if (showRow && monthFilter) {
            const monthIndex = Array.from(document.querySelectorAll('.realistic-table thead th'))
                .findIndex(th => th.textContent.trim() === monthFilter) - 1;
            if (monthIndex >= 0 && monthCells[monthIndex]) {
                const value = monthCells[monthIndex].textContent.trim();
                showRow = value !== '' && value !== '0';
            }
        }
        
        row.style.display = showRow ? '' : 'none';
    });
}

function exportChart() {
    if (currentChart) {
        const link = document.createElement('a');
        link.download = 'brand-performance-chart.png';
        link.href = currentChart.toBase64Image();
        link.click();
    }
}

// Chart type change handler
document.getElementById('chartType').addEventListener('change', initializeChart);
</script>

{% endblock %}
